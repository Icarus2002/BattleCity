<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title>Battle City</title>
  
  <link rel="stylesheet" type="text/css" href="css/BattleCity.css" />
  
  <script type="text/javascript" src="lib/jquery-1.7.2.js"></script>

  <script type="text/javascript" src="src/Utils.js"></script>
  <script type="text/javascript" src="src/Point.js"></script>
  <script type="text/javascript" src="src/Rect.js"></script>
  <script type="text/javascript" src="src/Sprite.js"></script>
  <script type="text/javascript" src="src/Tank.js"></script>
  <script type="text/javascript" src="src/Wall.js"></script>
  <script type="text/javascript" src="src/SpriteContainer.js"></script>
  <script type="text/javascript" src="src/CollisionDetector.js"></script>
  <script type="text/javascript" src="src/EventManager.js"></script>
  <script type="text/javascript" src="src/SpriteController.js"></script>
  <script type="text/javascript" src="src/TankController.js"></script>
  <script type="text/javascript" src="src/Keyboard.js"></script>
  <script type="text/javascript" src="src/BulletFactory.js"></script>
  <script type="text/javascript" src="src/Bullet.js"></script>
  <script type="text/javascript" src="src/Painter.js"></script>
  <script type="text/javascript" src="src/Updater.js"></script>
  <script type="text/javascript" src="src/BulletExplosionFactory.js"></script>
  <script type="text/javascript" src="src/Explosion.js"></script>
  <script type="text/javascript" src="src/BulletExplosion.js"></script>
  <script type="text/javascript" src="src/BrickWall.js"></script>
  <script type="text/javascript" src="src/SteelWall.js"></script>
  <script type="text/javascript" src="src/Cursor.js"></script>
  <script type="text/javascript" src="src/BlinkTimer.js"></script>
  <script type="text/javascript" src="src/CursorController.js"></script>
  <script type="text/javascript" src="src/Builder.js"></script>
  <script type="text/javascript" src="src/StructureManager.js"></script>
  <script type="text/javascript" src="src/BrickWallFactory.js"></script>
  <script type="text/javascript" src="src/SteelWallFactory.js"></script>
  <script type="text/javascript" src="src/Globals.js"></script>
  <script type="text/javascript" src="src/SpriteSerializer.js"></script>
  <script type="text/javascript" src="src/Base.js"></script>
  <script type="text/javascript" src="src/TankStateAppearing.js"></script>
  <script type="text/javascript" src="src/TankStateNormal.js"></script>
  <script type="text/javascript" src="src/TankStateInvincible.js"></script>
  <script type="text/javascript" src="src/AITankController.js"></script>
  <script type="text/javascript" src="src/Random.js"></script>
  <script type="text/javascript" src="src/AITankControllerFactory.js"></script>
  <script type="text/javascript" src="src/AITankControllerContainer.js"></script>
  <script type="text/javascript" src="src/EnemyFactory.js"></script>
  <script type="text/javascript" src="src/Animation.js"></script>
  <script type="text/javascript" src="src/TankExplosionFactory.js"></script>
  <script type="text/javascript" src="src/TankExplosion.js"></script>
  <script type="text/javascript" src="src/PointsFactory.js"></script>
  <script type="text/javascript" src="src/Points.js"></script>
  <script type="text/javascript" src="src/PlayerTankFactory.js"></script>
  <script type="text/javascript" src="src/PlayerTankControllerFactory.js"></script>
  <script type="text/javascript" src="src/PowerUpFactory.js"></script>
  <script type="text/javascript" src="src/PowerUp.js"></script>
  <script type="text/javascript" src="src/PowerUpHandler.js"></script>
  <script type="text/javascript" src="src/FreezeTimer.js"></script>
  <script type="text/javascript" src="src/BaseWallBuilder.js"></script>
  <script type="text/javascript" src="src/ShovelHandler.js"></script>
  <script type="text/javascript" src="src/Pause.js"></script>
  <script type="text/javascript" src="src/PauseListener.js"></script>
  <script type="text/javascript" src="src/BaseExplosionFactory.js"></script>
  <script type="text/javascript" src="src/BaseExplosion.js"></script>
  <script type="text/javascript" src="src/TankColor.js"></script>
  <script type="text/javascript" src="src/SceneManager.js"></script>
  <script type="text/javascript" src="src/MainMenuScene.js"></script>
  <script type="text/javascript" src="src/MainMenuItem.js"></script>
  <script type="text/javascript" src="src/OnePlayerMenuItem.js"></script>
  <script type="text/javascript" src="src/ConstructionMenuItem.js"></script>
  <script type="text/javascript" src="src/MainMenu.js"></script>
  <script type="text/javascript" src="src/MainMenuController.js"></script>
  <script type="text/javascript" src="src/MainMenuView.js"></script>
  <script type="text/javascript" src="src/MainMenuCursor.js"></script>
  <script type="text/javascript" src="src/MainMenuCursorView.js"></script>
  <script type="text/javascript" src="src/Gamefield.js"></script>
  <script type="text/javascript" src="src/Level.js"></script>
  <script type="text/javascript" src="src/EnemyFactoryView.js"></script>
  <script type="text/javascript" src="src/LivesView.js"></script>
  <script type="text/javascript" src="src/MainMenuView.js"></script>
  <script type="text/javascript" src="src/Curtain.js"></script>
  <script type="text/javascript" src="src/Script.js"></script>
  <script type="text/javascript" src="src/Delay.js"></script>
  <script type="text/javascript" src="src/GameScene.js"></script>
  <script type="text/javascript" src="src/StageMessage.js"></script>
  <script type="text/javascript" src="src/Stages.js"></script>
  <script type="text/javascript" src="src/MoveFn.js"></script>
  <script type="text/javascript" src="src/GameOverMessage.js"></script>
  <script type="text/javascript" src="src/StageStatisticsScene.js"></script>
  <script type="text/javascript" src="src/GameOverScene.js"></script>
  <script type="text/javascript" src="src/Player.js"></script>
  <script type="text/javascript" src="src/StageStatisticsPoints.js"></script>
  <script type="text/javascript" src="src/Trees.js"></script>
  <script type="text/javascript" src="src/Water.js"></script>
  <script type="text/javascript" src="src/LoadingScene.js"></script>
  
  <script type="text/javascript" src="lib/Stats.js"></script>
  <script type="text/javascript" src="src/FPSCounter.js"></script>
  
  <script type="text/javascript" src="src/ImageManager.js"></script>
  <script type="text/javascript" src="src/Construction.js"></script>
  <script type="text/javascript" src="src/SpriteSerializerController.js"></script>
  <script type="text/javascript" src="src/SpriteSerializer.js"></script>
  <script type="text/javascript" src="src/SoundManager.js"></script>

  <script type="text/javascript">
    $(function () {
      var FPS = 50;
      
      var CANVAS_ID = 'canvas';
      var ctx = createCanvasContext();
      ctx.font = "16px prstart"
      
      var eventManager = new EventManager();
      var keyboard = new Keyboard(eventManager);
      var sceneManager = new SceneManager(eventManager);
      sceneManager.toLoadingScene();
      
      setInterval(gameLoop, 1000 / FPS);
      
      function gameLoop() {
        keyboard.fireEvents();
        sceneManager.update();
        sceneManager.draw(ctx);
      }
      
      function createCanvasContext() {
        $('<canvas id="' + CANVAS_ID + '" width="' + Globals.CANVAS_WIDTH + '" height="' + Globals.CANVAS_HEIGHT + '"></canvas>').prependTo('#main');
        var canvas = document.getElementById(CANVAS_ID);
        return canvas.getContext('2d');
      };
    });
  </script>

</head>

<body>
  <div id="main">
    <div id="help">
      <p>CONTROLS:</p>
      <table>
        <tr>
          <td><img src="images/Nintendo-Dpad-Neutral.png" alt="" /></td>
          <td>ARROWS</td>
        </tr>
        <tr>
          <td><img src="images/Nintendo-Button-A.png" alt="" />,<img src="images/Nintendo-Button-B.png" alt="" /></td>
          <td>SPACE</td>
        </tr>
        <tr>
          <td><img src="images/Nintendo-Button-Start.png" alt="" /></td>
          <td>ENTER</td>
        </tr>
        <tr>
          <td><img src="images/Nintendo-Button-Select.png" alt="" /></td>
          <td>CTRL</td>
        </tr>
      </table>
    </div>
  </div>
  <!-- =========================
     MOBILE TOUCH CONTROLS
     Paste before </body>
========================= -->

<style>
  /* показываем только на тач-устройствах */
  @media (pointer: fine) {
    .bcTouchWrap { display: none !important; }
  }

  .bcTouchWrap{
    position: fixed;
    left: calc(12px + env(safe-area-inset-left));
    right: calc(12px + env(safe-area-inset-right));
    bottom: calc(12px + env(safe-area-inset-bottom));
    display: flex;
    justify-content: space-between;
    gap: 12px;
    z-index: 999999;
    pointer-events: none; /* включим клики только внутри панелей */
  }

  .bcTouchPad, .bcTouchActions{
    pointer-events: auto;
    background: rgba(0,0,0,.35);
    border: 1px solid rgba(255,255,255,.18);
    backdrop-filter: blur(10px);
    border-radius: 18px;
    padding: 10px;
    box-shadow: 0 12px 40px rgba(0,0,0,.35);
    user-select: none;
    -webkit-user-select: none;
    touch-action: none;
  }

  .bcTouchPad{
    display: grid;
    grid-template-columns: repeat(3, 52px);
    grid-template-rows: repeat(3, 52px);
    gap: 8px;
    align-items: center;
    justify-items: center;
  }

  .bcTouchActions{
    display: grid;
    grid-template-columns: 92px;
    grid-auto-rows: 52px;
    gap: 8px;
    align-content: start;
  }

  .bcBtn{
    width: 52px;
    height: 52px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.08);
    color: rgba(255,255,255,.95);
    font-weight: 900;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
    touch-action: none;
  }

  .bcBtn:active{ transform: translateY(1px); }

  .bcAction{
    height: 52px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.18);
    background: linear-gradient(135deg, rgba(102,217,255,.22), rgba(255,92,122,.18));
    color: rgba(255,255,255,.96);
    font-weight: 900;
    font-size: 13px;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  .bcAction.secondary{
    background: rgba(255,255,255,.08);
    font-weight: 850;
  }

  .bcSpacer{
    width: 52px;
    height: 52px;
  }

  /* чуть уменьшим на очень маленьких экранах */
  @media (max-width: 360px){
    .bcTouchPad{ grid-template-columns: repeat(3, 46px); grid-template-rows: repeat(3, 46px); }
    .bcBtn{ width: 46px; height: 46px; border-radius: 14px; }
    .bcTouchActions{ grid-template-columns: 84px; grid-auto-rows: 46px; }
    .bcAction{ height: 46px; border-radius: 14px; font-size: 12px; }
    .bcSpacer{ width: 46px; height: 46px; }
  }
</style>

<div class="bcTouchWrap" id="bcTouchWrap" aria-hidden="true">
  <!-- D-Pad -->
  <div class="bcTouchPad">
    <div class="bcSpacer"></div>
    <button class="bcBtn" data-key="ArrowUp" data-keycode="38" aria-label="Вверх">▲</button>
    <div class="bcSpacer"></div>

    <button class="bcBtn" data-key="ArrowLeft" data-keycode="37" aria-label="Влево">◀</button>
    <div class="bcSpacer"></div>
    <button class="bcBtn" data-key="ArrowRight" data-keycode="39" aria-label="Вправо">▶</button>

    <div class="bcSpacer"></div>
    <button class="bcBtn" data-key="ArrowDown" data-keycode="40" aria-label="Вниз">▼</button>
    <div class="bcSpacer"></div>
  </div>

  <!-- Actions -->
  <div class="bcTouchActions">
    <button class="bcAction" id="bcFire" data-key=" " data-keycode="32">ОГОНЬ</button>
    <button class="bcAction secondary" id="bcStart" data-key="Enter" data-keycode="13">START</button>
    <button class="bcAction secondary" id="bcCtrl" data-key="Control" data-keycode="17">CTRL</button>
  </div>
</div>

<script>
(function () {
  // На всякий случай отключаем “резиновый” скролл на тачах
  try {
    document.documentElement.style.overscrollBehavior = 'none';
    document.body.style.overscrollBehavior = 'none';
  } catch(e){}

  // Пытаемся сфокусировать страницу игры (важно для обработчиков keydown)
  function ensureFocus(){
    try { window.focus(); } catch(e){}
    // Если у игры есть canvas — попробуем дать ему фокус
    var c = document.
      querySelector('canvas');
    if (c) {
      if (!c.hasAttribute('tabindex')) c.setAttribute('tabindex', '0');
      try { c.focus(); } catch(e){}
    }
  }

  function makeKeyboardEvent(type, key, keyCode){
    var ev;
    try {
      ev = new KeyboardEvent(type, {
        key: key,
        code: key,
        bubbles: true,
        cancelable: true
      });
      // keyCode/which часто read-only — подменим через defineProperty
      Object.defineProperty(ev, 'keyCode', { get: function(){ return keyCode; } });
      Object.defineProperty(ev, 'which',   { get: function(){ return keyCode; } });
    } catch (e) {
      ev = document.createEvent('Event');
      ev.initEvent(type, true, true);
      ev.keyCode = keyCode;
      ev.which = keyCode;
    }
    return ev;
  }

  function keyDown(key, keyCode){
    ensureFocus();
    var ev = makeKeyboardEvent('keydown', key, keyCode);
    document.dispatchEvent(ev);
    window.dispatchEvent(ev);
  }

  function keyUp(key, keyCode){
    ensureFocus();
    var ev = makeKeyboardEvent('keyup', key, keyCode);
    document.dispatchEvent(ev);
    window.dispatchEvent(ev);
  }

  // Для стрелок — удержание (нажат/отпустил)
  function bindHold(btn){
    var key = btn.getAttribute('data-key');
    var keyCode = parseInt(btn.getAttribute('data-keycode'), 10);

    var pressed = false;

    function down(e){
      e.preventDefault();
      if (pressed) return;
      pressed = true;
      keyDown(key, keyCode);
    }
    function up(e){
      e.preventDefault();
      if (!pressed) return;
      pressed = false;
      keyUp(key, keyCode);
    }

    // Pointer Events (лучше всего)
    btn.addEventListener('pointerdown', down, { passive: false });
    btn.addEventListener('pointerup', up, { passive: false });
    btn.addEventListener('pointercancel', up, { passive: false });
    btn.addEventListener('pointerleave', up, { passive: false });

    // Fallback на старые браузеры
    btn.addEventListener('touchstart', down, { passive: false });
    btn.addEventListener('touchend', up, { passive: false });
    btn.addEventListener('touchcancel', up, { passive: false });

    btn.addEventListener('mousedown', down);
    btn.addEventListener('mouseup', up);
    btn.addEventListener('mouseleave', up);
  }

  // Для кнопок “Огонь/Start/Ctrl” — короткий тап
  function bindTap(btn){
    var key = btn.getAttribute('data-key');
    var keyCode = parseInt(btn.getAttribute('data-keycode'), 10);

    function tap(e){
      e.preventDefault();
      keyDown(key, keyCode);
      setTimeout(function(){ keyUp(key, keyCode); }, 60);
    }

    btn.addEventListener('click', tap);
    btn.addEventListener('touchstart', tap, { passive: false });
    btn.addEventListener('pointerdown', tap, { passive: false });
  }

  // Привязки
  document.querySelectorAll('.bcTouchPad .bcBtn[data-keycode]').forEach(bindHold);
  bindTap(document.getElementById('bcFire'));
  bindTap(document.getElementById('bcStart'));
  bindTap(document.getElementById('bcCtrl'));

  // На всякий случай, при первом тапе по экрану — фокус
  document.addEventListener('touchstart', ensureFocus, { passive: true });
})();
</script>

<!-- =========================
     /MOBILE TOUCH CONTROLS
========================= -->
</body>
</html>
